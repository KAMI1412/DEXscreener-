<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana On-Chain Analyzer | RPC Engine</title>
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #0a0b0d;
            --card-bg: #16181c;
            --accent-color: #00f2ff;
            --secondary-accent: #7000ff;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00ffbd;
            --danger: #ff4d4d;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease-out;
        }

        .logo-section h1 {
            font-size: 1.8rem;
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .logo-section p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Toolbar & RPC Settings */
        .toolbar {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: rgba(22, 24, 28, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            margin-bottom: 2rem;
        }

        .rpc-config {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .rpc-config input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: #00ffbd;
            padding: 0.6rem;
            border-radius: 8px;
            flex: 1;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 16px;
            transition: transform 0.3s ease;
            position: relative;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .data-table-container {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            height: fit-content;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .badge-success {
            background: rgba(0, 255, 189, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 165, 0, 0.1);
            color: #ffa500;
        }

        .badge-rpc {
            background: rgba(0, 242, 255, 0.1);
            color: var(--accent-color);
        }

        .elite-wallet {
            background: rgba(255, 215, 0, 0.05) !important;
            border-left: 3px solid #ffd700;
        }

        /* Live Feed */
        .live-feed {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1rem;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .feed-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-color);
        }

        #feed-content {
            flex: 1;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .feed-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            animation: slideIn 0.3s ease-out;
        }

        .feed-item .time {
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .feed-item .msg {
            color: #fff;
        }

        .feed-item .tag {
            color: var(--success);
            font-weight: 700;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .refresh-btn {
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-accent));
            border: none;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <h1>ON-CHAIN BATTLESTATION</h1>
                <p>Real-Time Solana RPC Insights & Token Discovery</p>
            </div>
            <div class="search-container" style="display: flex; gap: 10px; max-width: 400px; flex: 1; margin: 0 1rem;">
                <input type="text" id="ca-input" placeholder="Solana CA Scan..."
                    style="background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 0.7rem; border-radius: 10px; flex: 1; font-family: monospace;">
                <button class="refresh-btn" id="scan-ca-btn">Scan</button>
            </div>
            <button class="refresh-btn" id="refresh-btn">
                <i data-lucide="zap"></i> Quick Scan
            </button>
        </header>

        <div class="toolbar">
            <div class="rpc-config">
                <span style="font-size: 0.75rem; color: var(--text-secondary); align-self: center;">SOLANA RPC:</span>
                <input type="text" id="rpc-url" placeholder="Paste QuickNode/Alchemy/Helius URL..."
                    value="https://api.mainnet-beta.solana.com">
                <span id="connection-status" class="badge badge-rpc">CONNECTING...</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header"><span>Block Height</span><i data-lucide="cloud"></i></div>
                <div class="stat-value" id="stat-height">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-header"><span>RPC Latency</span><i data-lucide="activity"></i></div>
                <div class="stat-value" style="color: var(--success);" id="stat-latency">- ms</div>
            </div>
            <div class="stat-card">
                <div class="stat-header"><span>On-Chain Events</span><i data-lucide="database"></i></div>
                <div class="stat-value" id="stat-events">0</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="content-left">
                <section>
                    <div class="section-header">
                        <h3 style="display:flex;align-items:center;gap:8px;"><i data-lucide="flame"
                                style="color:#ffa500"></i> Hot Pairs (DexScreener + RPC Verification)</h3>
                    </div>
                    <div class="data-table-container">
                        <table id="token-table">
                            <thead>
                                <tr>
                                    <th>Token</th>
                                    <th>Price/Growth</th>
                                    <th>Liquidity (USD)</th>
                                    <th>Verified?</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="token-body">
                                <tr>
                                    <td colspan="5" class="loader">
                                        <div class="spinner"></div>
                                        <p style="margin-top:1rem; color:var(--text-secondary);">Listening to chain...
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="wallet-section" style="display: none; margin-top: 2rem;">
                    <div class="section-header">
                        <h3><i data-lucide="wallet"></i> Holder Verification</h3>
                    </div>
                    <div class="data-table-container">
                        <table id="wallet-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Address</th>
                                    <th>Profit</th>
                                    <th>Token Balance</th>
                                    <th>Label</th>
                                </tr>
                            </thead>
                            <tbody id="wallet-body"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div class="content-right">
                <div class="live-feed">
                    <div class="feed-header"><i data-lucide="radio"></i> Real-Time Feed</div>
                    <div id="feed-content">
                        <!-- Items injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { Connection, PublicKey } = solanaWeb3;

        let connection;
        let eventCount = 0;

        const FILTERS = {
            MIN_LIQUIDITY: 5000,
            STRICT_GROWTH: 1000
        };

        const API = {
            SEARCH: (q) => `https://api.dexscreener.com/latest/dex/search/?q=${q}`,
            BOOSTS: 'https://api.dexscreener.com/token-boosts/latest/v1',
            PROFILES: 'https://api.dexscreener.com/token-profiles/latest/v1',
            TOP_TRADERS: (pairAddr) => `https://io.dexscreener.com/dex/log/top-traders/v2/solana/${pairAddr}`,
            PROXY: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
        };

        // UI Elements
        const rpcInput = document.getElementById('rpc-url');
        const connStatus = document.getElementById('connection-status');
        const feedContent = document.getElementById('feed-content');
        const tokenBody = document.getElementById('token-body');
        const walletSection = document.getElementById('wallet-section');
        const walletBody = document.getElementById('wallet-body');

        const statHeight = document.getElementById('stat-height');
        const statLatency = document.getElementById('stat-latency');
        const statEvents = document.getElementById('stat-events');

        lucide.createIcons();

        // 1. Initialize RPC Connection
        async function initRPC() {
            const url = rpcInput.value.trim();
            try {
                connStatus.innerText = "CONNECTING...";
                connStatus.className = "badge badge-rpc";

                const start = Date.now();
                connection = new Connection(url, 'confirmed');
                const height = await connection.getBlockHeight();
                const latency = Date.now() - start;

                statHeight.innerText = height.toLocaleString();
                statLatency.innerText = `${latency}ms`;
                connStatus.innerText = "CONNECTED";
                connStatus.style.color = "var(--success)";

                logToFeed(`RPC Linked: ${url.substring(0, 20)}...`, 'system');
            } catch (e) {
                console.error("RPC Error:", e);
                connStatus.innerText = "DISCONNECTED";
                connStatus.style.color = "var(--danger)";
                logToFeed(`RPC Error: Failed to link. Check URL.`, 'error');
            }
        }

        function logToFeed(msg, type = 'info') {
            eventCount++;
            statEvents.innerText = eventCount;

            const div = document.createElement('div');
            div.className = 'feed-item';
            const now = new Date();
            const time = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

            let tag = '';
            if (type === 'new') tag = '<span class="tag">[NEW POOL]</span> ';
            if (type === 'whale') tag = '<span class="tag" style="color:#ff00ff">[WHALE BUY]</span> ';

            div.innerHTML = `<span class="time">${time}</span> ${tag}${msg}`;
            feedContent.prepend(div);
        }

        // 2. Fetch Tokens with Multi-Source Discovery
        async function fetchTokens() {
            tokenBody.innerHTML = '<tr><td colspan="5" class="loader"><div class="spinner"></div></td></tr>';

            try {
                logToFeed(`Scanning DexScreener & On-Chain feeds...`);
                let allPairs = [];

                // Parallel discovery
                const [boostRes, profileRes] = await Promise.all([
                    fetch(API.BOOSTS).then(r => r.json()),
                    fetch(API.PROFILES).then(r => r.json())
                ]);

                // Filter for Solana
                const hotAddrs = [
                    ...boostRes.slice(0, 5).map(b => b.tokenAddress),
                    ...profileRes.filter(p => p.chainId === 'solana').slice(0, 10).map(p => p.tokenAddress)
                ].join(',');

                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${hotAddrs}`);
                const data = await res.json();
                if (data.pairs) allPairs = data.pairs;

                // De-duplicate & Filter
                const solPairs = allPairs.filter(p => p.chainId === 'solana' && (p.liquidity?.usd || 0) >= FILTERS.MIN_LIQUIDITY);
                solPairs.sort((a, b) => (b.priceChange?.h24 || 0) - (a.priceChange?.h24 || 0));

                renderTokens(solPairs);

            } catch (e) {
                logToFeed(`Discovery error: ${e.message}`, 'error');
                tokenBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--danger);">Scan Failed. Try again.</td></tr>';
            }
        }

        function renderTokens(tokens) {
            tokenBody.innerHTML = '';
            if (tokens.length === 0) {
                tokenBody.innerHTML = '<tr><td colspan="5" style="text-align:center">No active pairs found.</td></tr>';
                return;
            }

            tokens.forEach(token => {
                const tr = document.createElement('tr');
                const h24 = token.priceChange?.h24 || 0;
                const isExtreme = h24 >= FILTERS.STRICT_GROWTH;

                tr.innerHTML = `
                    <td>
                        <div style="font-weight:700">${token.baseToken.name}</div>
                        <div style="font-size:0.7rem; color:var(--text-secondary)">${token.baseToken.symbol}</div>
                    </td>
                    <td>
                        <div class="${h24 >= 0 ? 'up' : 'down'}">${h24.toFixed(2)}%</div>
                        <div style="font-size:0.7rem">$${token.priceUsd}</div>
                    </td>
                    <td>$${(token.liquidity?.usd || 0).toLocaleString()}</td>
                    <td><span id="v-${token.pairAddress}" class="badge badge-rpc">PENDING...</span></td>
                    <td>
                        <button class="refresh-btn" style="padding:4px 8px; font-size:0.7rem" onclick="verifyAndAnalyze('${token.pairAddress}', '${token.baseToken.name}', '${token.baseToken.address}')">
                            VERIFY
                        </button>
                    </td>
                `;
                tokenBody.appendChild(tr);

                // Automatic background verification
                verifyOnChain(token.pairAddress, token.baseToken.address);
            });
        }

        async function verifyOnChain(pairAddr, mintAddr) {
            if (!connection) return;
            try {
                const badge = document.getElementById(`v-${pairAddr}`);
                const bal = await connection.getAccountInfo(new PublicKey(pairAddr));
                if (bal) {
                    badge.innerText = "VERIFIED";
                    badge.style.color = "var(--success)";
                    badge.style.background = "rgba(0, 255, 189, 0.1)";
                    logToFeed(`Verified Pool Storage: ${pairAddr.substring(0, 6)}...`, 'info');
                }
            } catch (e) { }
        }

        async function verifyAndAnalyze(pairAddr, tokenName, mintAddr) {
            walletSection.style.display = 'block';
            walletBody.innerHTML = '<tr><td colspan="5" class="loader"><div class="spinner"></div></td></tr>';
            walletSection.scrollIntoView({ behavior: 'smooth' });

            try {
                logToFeed(`Running RPC Audit for ${tokenName}...`);
                const url = API.TOP_TRADERS(pairAddr);
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                const json = await res.json();
                const data = JSON.parse(json.contents);

                if (!data.traders) throw new Error("No logs");

                const top30 = data.traders.slice(0, 30);
                renderWallets(top30, mintAddr);
            } catch (e) {
                walletBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--danger);">Audit failed. RPC or Proxy error.</td></tr>';
            }
        }

        async function renderWallets(traders, mintAddr) {
            walletBody.innerHTML = '';

            for (const [index, t] of traders.entries()) {
                const tr = document.createElement('tr');
                const profit = t.pnl || 0;
                const buyUsd = t.boughtUsd || 0;
                const profitPct = buyUsd > 0 ? ((profit / buyUsd) * 100).toFixed(0) : "0";
                const isElite = profitPct >= 500 && profit > 0;

                if (isElite) tr.className = 'elite-wallet';

                // Real-time on-chain balance check (if RPC works)
                let rpcLabel = "Checking...";
                try {
                    if (connection) {
                        const bal = await connection.getBalance(new PublicKey(t.maker));
                        rpcLabel = (bal / 1e9).toFixed(2) + " SOL";
                    }
                } catch (e) { rpcLabel = "Error"; }

                tr.innerHTML = `
                    <td>#${index + 1}</td>
                    <td style="font-family:monospace">
                        <a href="https://solscan.io/account/${t.maker}" target="_blank" style="color:var(--accent-color); text-decoration:none">
                            ${t.maker.substring(0, 4)}...${t.maker.substring(t.maker.length - 4)}
                        </a>
                    </td>
                    <td class="${profit >= 0 ? 'up' : 'down'}">$${profit.toLocaleString()} (${profitPct}%)</td>
                    <td id="b-${t.maker}">${rpcLabel}</td>
                    <td><span class="badge ${isElite ? 'badge-success' : 'badge-rpc'}">${isElite ? 'ELITE' : 'ACTIVE'}</span></td>
                `;
                walletBody.appendChild(tr);
            }
        }

        async function scanCa() {
            const ca = document.getElementById('ca-input').value.trim();
            if (!ca) return;

            tokenBody.innerHTML = '<tr><td colspan="5" class="loader"><div class="spinner"></div></td></tr>';
            try {
                logToFeed(`On-Chain Probe: Scanning ${ca}...`, 'info');
                const res = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${ca}`);
                const data = await res.json();
                if (data.pairs) renderTokens(data.pairs.filter(p => p.chainId === 'solana'));
            } catch (e) { logToFeed(`CA Scan Error`, 'error'); }
        }

        // Initialize
        document.getElementById('refresh-btn').addEventListener('click', fetchTokens);
        document.getElementById('scan-ca-btn').addEventListener('click', scanCa);
        rpcInput.addEventListener('change', initRPC);

        initRPC();
        fetchTokens();

        // Interval updates
        setInterval(async () => {
            if (connection) {
                const h = await connection.getBlockHeight();
                statHeight.innerText = h.toLocaleString();
            }
        }, 5000);
    </script>
</body>

</html>